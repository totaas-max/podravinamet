<!DOCTYPE html>
<html lang="hr" class="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Podravina Meteo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Proj4js for Coordinate Conversion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.11.0/proj4.js"></script>
    
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#137fec",
              "background-light": "#f6f7f8",
              "background-dark": "#101922",
              "surface-light": "#ffffff",
              "surface-dark": "#1e2936",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"],
              "sans": ["Inter", "sans-serif"]
            },
          },
        },
      }
    </script>
    <style>
      body {
        -webkit-tap-highlight-color: transparent;
      }
      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .pb-safe {
        padding-bottom: env(safe-area-inset-bottom, 20px);
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      /* Leaflet Customizations */
      .leaflet-container {
        font-family: 'Inter', sans-serif;
        background: #e5e7eb;
      }
      .dark .leaflet-container {
        background: #374151;
      }
      .custom-div-icon {
        background: transparent;
        border: none;
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white font-display antialiased selection:bg-blue-100 selection:text-blue-900 overflow-x-hidden">
    
    <!-- App Container -->
    <div id="app" class="flex flex-col min-h-screen md:flex-row">
      <!-- Content injected by JS -->
    </div>

    <script>
      // --- Constants & Data ---
      
      const VIEW_STATE = {
        HOME: 'home',
        RADAR: 'radar',
        AGRO: 'agro',
        NEWS: 'news',
        SETTINGS: 'settings'
      };

      const LAYER_TYPES = {
          TEMP: 'temp',
          WIND: 'wind',
          HUMIDITY: 'humidity',
          PRESSURE: 'pressure'
      };

      const MEASUREMENT_IDS = {
          30: 'temp',       // Temperatura
          31: 'windSpeed',  // Brzina vjetra
          32: 'windDir',    // Smjer vjetra
          33: 'humidity',   // Relativna vlažnost
          5: 'pressure'     // Tlak zraka
      };

      const MET_SYMBOLS = {
        'clearsky': { icon: 'sunny', class: 'text-amber-500', label: 'Vedro', priority: 1 },
        'fair': { icon: 'partly_cloudy_day', class: 'text-amber-400', label: 'Djelomično vedro', priority: 2 },
        'partlycloudy': { icon: 'partly_cloudy_day', class: 'text-gray-500', label: 'Djelomično oblačno', priority: 3 },
        'cloudy': { icon: 'cloud', class: 'text-gray-500', label: 'Oblačno', priority: 4 },
        'lightrainshowers': { icon: 'rainy_light', class: 'text-blue-300', label: 'Slabi pljuskovi', priority: 5 },
        'rainshowers': { icon: 'rainy', class: 'text-blue-400', label: 'Pljuskovi', priority: 6 },
        'heavyrainshowers': { icon: 'rainy_heavy', class: 'text-blue-600', label: 'Jaki pljuskovi', priority: 7 },
        'lightrain': { icon: 'rainy_light', class: 'text-blue-400', label: 'Slaba kiša', priority: 5 },
        'rain': { icon: 'rainy', class: 'text-blue-500', label: 'Kiša', priority: 6 },
        'heavyrain': { icon: 'rainy_heavy', class: 'text-blue-700', label: 'Jaka kiša', priority: 8 },
        'lightsleet': { icon: 'weather_mix', class: 'text-cyan-400', label: 'Slaba susnježica', priority: 6 },
        'sleet': { icon: 'weather_snowy', class: 'text-cyan-500', label: 'Susnježica', priority: 7 },
        'heavysleet': { icon: 'weather_snowy', class: 'text-cyan-600', label: 'Jaka susnježica', priority: 8 },
        'lightsnow': { icon: 'ac_unit', class: 'text-cyan-200', label: 'Slab snijeg', priority: 6 },
        'snow': { icon: 'ac_unit', class: 'text-cyan-300', label: 'Snijeg', priority: 7 },
        'heavysnow': { icon: 'weather_snowy', class: 'text-cyan-400', label: 'Jak snijeg', priority: 9 },
        'fog': { icon: 'foggy', class: 'text-gray-400', label: 'Magla', priority: 5 },
        'lightrainshowersandthunder': { icon: 'thunderstorm', class: 'text-purple-400', label: 'Slabi pljuskovi s grmljavinom', priority: 8 },
        'rainshowersandthunder': { icon: 'thunderstorm', class: 'text-purple-500', label: 'Pljuskovi s grmljavinom', priority: 9 },
        'heavyrainshowersandthunder': { icon: 'thunderstorm', class: 'text-purple-600', label: 'Jaki pljuskovi s grmljavinom', priority: 10 },
        'lightrainandthunder': { icon: 'thunderstorm', class: 'text-purple-400', label: 'Slaba kiša s grmljavinom', priority: 8 },
        'rainandthunder': { icon: 'thunderstorm', class: 'text-purple-500', label: 'Kiša s grmljavinom', priority: 9 },
        'heavyrainandthunder': { icon: 'thunderstorm', class: 'text-purple-700', label: 'Jaka kiša s grmljavinom', priority: 10 },
        'lightsleetandthunder': { icon: 'thunderstorm', class: 'text-purple-400', label: 'Slaba susnježica s grmljavinom', priority: 9 },
        'sleetandthunder': { icon: 'thunderstorm', class: 'text-purple-500', label: 'Susnježica s grmljavinom', priority: 9 },
        'heavysleetandthunder': { icon: 'thunderstorm', class: 'text-purple-600', label: 'Jaka susnježica s grmljavinom', priority: 10 },
        'lightsnowandthunder': { icon: 'thunderstorm', class: 'text-purple-300', label: 'Slab snijeg s grmljavinom', priority: 9 },
        'snowandthunder': { icon: 'thunderstorm', class: 'text-purple-400', label: 'Snijeg s grmljavinom', priority: 9 },
        'heavysnowandthunder': { icon: 'thunderstorm', class: 'text-purple-500', label: 'Jak snijeg s grmljavinom', priority: 10 }
      };

      const newsData = [
         {
          id: 1,
          title: "Meteo portal Podravina",
          date: "16.12.2025.",
          image: "https://explore-croatia.net/wp-content/uploads/2021/05/DJI_0149-700x510.jpg", 
          summary: "Meteo portal Podravina",
          content: "Od danas je počeo sa radom meteo portal s fokusom na Podravinu. Na ovom meteoportalu moguće je pronaći trenutne temperature izmjerene na DHMZ mreži meteoroloških postaja, prognoze vremena za odabrane lokacije, radarsku sliku oborine, agro savjete i lokalne meteo zanimljivosti. "
        },
      ];

      // --- State ---
      let state = {
        activeTab: VIEW_STATE.HOME,
        activeLayer: LAYER_TYPES.TEMP,
        stationsMap: new Map(), 
        nearestStation: null,
        locations: [], 
        activeLocationIndex: 0,
        searchQuery: '',
        searchResults: [],
        isSearching: false,
        forecastData: [], 
        hourlyData: {}, 
        selectedDay: null, 
        forecastUpdated: null, 
        isForecastExpanded: false, 
        agroData: [],
        isAgroLoading: false,
        agroMeteo: { stanje: null, forecast: null, forecastPeriod: null, outlook: null, outlookPeriod: null },
        isLoading: false,
        lastUpdated: null,
        radarPlaying: false,
        radarFrames: [], 
        currentRadarIndex: 0,
        warnings: { today: [], tomorrow: [], dayAfter: [] },
        showWarningsModal: false,
        warningTab: 'today',
        selectedNews: null,
        aqi: null,
        // Astro Data
        astro: {
            sunrise: null,
            sunset: null,
            moonPhase: null,
            moonPhaseValue: 0
        }
      };

      let mapInstance = null;
      let markersLayer = null;
      let radarInterval = null;
      let searchTimeout = null;

      const app = document.getElementById('app');

      // --- Logic: Utils ---

      function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; 
        var dLat = deg2rad(lat2-lat1);  
        var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c; 
      }

      function deg2rad(deg) { return deg * (Math.PI/180) }

      function categorizeTitle(title) {
        const t = title.toLowerCase();
        if (t.includes('jabuk') || t.includes('krusk') || t.includes('breskv') || t.includes('sljiv') || t.includes('visnj') || t.includes('voc') || t.includes('nasad') || t.includes('vinograd') || t.includes('loz')) {
          return { name: 'Voćarstvo', icon: 'pest_control', color: 'text-red-600', bg: 'bg-red-50 dark:bg-red-900/20' };
        }
        if (t.includes('psenic') || t.includes('jecam') || t.includes('kukuruz') || t.includes('soj') || t.includes('uljan') || t.includes('repic') || t.includes('ratar')) {
          return { name: 'Ratarstvo', icon: 'bug_report', color: 'text-amber-600', bg: 'bg-amber-50 dark:bg-amber-900/20' };
        }
        if (t.includes('povrc') || t.includes('kupus') || t.includes('luk') || t.includes('salat') || t.includes('rajcic') || t.includes('paprik')) {
          return { name: 'Povrtlarstvo', icon: 'potted_plant', color: 'text-green-600', bg: 'bg-green-50 dark:bg-green-900/20' };
        }
        return { name: 'Aktualno', icon: 'agriculture', color: 'text-blue-600', bg: 'bg-blue-50 dark:bg-blue-900/20' };
      }

      function saveLocations() {
          localStorage.setItem('pm_locations', JSON.stringify(state.locations));
          localStorage.setItem('pm_active_index', state.activeLocationIndex);
      }

      function loadLocations() {
          const storedLocs = localStorage.getItem('pm_locations');
          const storedIndex = localStorage.getItem('pm_active_index');
          if (storedLocs) {
              state.locations = JSON.parse(storedLocs);
              state.activeLocationIndex = storedIndex ? parseInt(storedIndex) : 0;
              if (state.activeLocationIndex >= state.locations.length) state.activeLocationIndex = 0;
          } else {
              state.locations = [{ id: 'gps', name: 'Moja Lokacija (GPS)', type: 'gps', lat: 46.16, lon: 16.83 }];
              state.activeLocationIndex = 0;
          }
      }

      function getActiveLocation() { return state.locations[state.activeLocationIndex]; }

      function formatWarningTime(isoString) {
          if (!isoString) return { time: '--:--', date: '' };
          const date = new Date(isoString);
          const today = new Date();
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          const timeStr = date.toLocaleTimeString('hr-HR', { hour: '2-digit', minute: '2-digit' });
          let dateStr = date.toLocaleDateString('hr-HR', { day: 'numeric', month: 'short' });
          if (date.toDateString() === today.toDateString()) dateStr = 'Danas';
          else if (date.toDateString() === tomorrow.toDateString()) dateStr = 'Sutra';
          return { time: timeStr, date: dateStr };
      }

      function getAqiStatus(val) {
          if (val === null || val === undefined) return { label: '--', color: 'text-gray-400', icon: 'help' };
          if(val < 20) return { label: 'Dobro', color: 'text-green-500', icon: 'check_circle' };
          if(val < 40) return { label: 'Prihvatljivo', color: 'text-teal-500', icon: 'thumb_up' };
          if(val < 60) return { label: 'Umjereno', color: 'text-yellow-500', icon: 'sentiment_neutral' };
          if(val < 80) return { label: 'Loše', color: 'text-orange-500', icon: 'sentiment_dissatisfied' };
          if(val < 100) return { label: 'Jako loše', color: 'text-red-500', icon: 'warning' };
          return { label: 'Opasno', color: 'text-purple-500', icon: 'error' };
      }

      function getMoonPhaseDesc(phase) {
          // Phase 0-360
          // 0 = New Moon, 90 = First Quarter, 180 = Full Moon, 270 = Last Quarter
          if (phase === null || phase === undefined) return { label: '--', icon: 'brightness_3' };
          
          if (phase < 5 || phase > 355) return { label: 'Mlađak', icon: 'circle', color: 'text-gray-600' };
          if (phase < 85) return { label: 'Rastući srp', icon: 'brightness_3', color: 'text-gray-300' }; // Simplified icon
          if (phase < 95) return { label: 'Prva četvrt', icon: 'contrast', color: 'text-gray-300' };
          if (phase < 175) return { label: 'Rastući mjesec', icon: 'brightness_2', color: 'text-gray-200' };
          if (phase < 185) return { label: 'Pun mjesec', icon: 'brightness_1', color: 'text-yellow-100' };
          if (phase < 265) return { label: 'Padajući mjesec', icon: 'brightness_2', color: 'text-gray-200' };
          if (phase < 275) return { label: 'Zadnja četvrt', icon: 'contrast', color: 'text-gray-300' };
          return { label: 'Padajući srp', icon: 'brightness_3', color: 'text-gray-300' };
      }

      // --- Logic: Data Fetching ---

      async function fetchAstroData() {
         const activeLoc = getActiveLocation();
         const lat = activeLoc.lat || 46.16;
         const lon = activeLoc.lon || 16.83;
         const date = new Date().toISOString().split('T')[0];
         const offset = "+01:00"; // Hardcoded for HR basic

         // Fetch Sun
         const sunUrl = `https://api.met.no/weatherapi/sunrise/3.0/sun?lat=${lat}&lon=${lon}&date=${date}&offset=${offset}`;
         // Fetch Moon
         const moonUrl = `https://api.met.no/weatherapi/sunrise/3.0/moon?lat=${lat}&lon=${lon}&date=${date}&offset=${offset}`;

         const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(sunUrl);
         const proxyMoon = 'https://corsproxy.io/?' + encodeURIComponent(moonUrl);

         try {
             // Sun
             const sRes = await fetch(proxyUrl);
             const sData = await sRes.json();
             if (sData.properties) {
                const rise = sData.properties.sunrise.time;
                const set = sData.properties.sunset.time;
                state.astro.sunrise = rise ? rise.split('T')[1].substring(0, 5) : '--:--';
                state.astro.sunset = set ? set.split('T')[1].substring(0, 5) : '--:--';
             }

             // Moon
             const mRes = await fetch(proxyMoon);
             const mData = await mRes.json();
             if (mData.properties) {
                 state.astro.moonPhaseValue = mData.properties.moonphase;
                 state.astro.moonPhase = getMoonPhaseDesc(mData.properties.moonphase);
             }
             
             if (state.activeTab === VIEW_STATE.HOME) render();

         } catch (e) {
             console.error("Astro fetch failed", e);
         }
      }

      async function fetchAirQuality() {
         const activeLoc = getActiveLocation();
         const lat = activeLoc.lat || 46.16;
         const lon = activeLoc.lon || 16.83;
         const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=european_aqi`;
         
         try {
             const res = await fetch(url);
             const data = await res.json();
             if (data.current && typeof data.current.european_aqi !== 'undefined') {
                 state.aqi = data.current.european_aqi;
             } else {
                 state.aqi = null;
             }
             if (state.activeTab === VIEW_STATE.HOME) updateDashboard();
         } catch (e) {
             console.error("AQI fetch failed", e);
             state.aqi = null;
         }
      }

      async function fetchForecastData() {
         const activeLoc = getActiveLocation();
         const lat = activeLoc.lat || 46.16;
         const lon = activeLoc.lon || 16.83;
         const url = `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`;
         const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);

         try {
             const res = await fetch(proxyUrl);
             if(!res.ok) throw new Error("Forecast fetch failed");
             const json = await res.json();
             processForecastData(json);
         } catch (e) {
             console.error("Forecast error:", e);
         }
      }

    function processForecastData(data) {
    if (!data || !data.properties || !data.properties.timeseries) return;
    const dailyGroups = {};

    data.properties.timeseries.forEach(point => {
        const date = point.time.split('T')[0];
        const time = point.time.split('T')[1].substring(0, 5); 
        if (!dailyGroups[date]) {
            dailyGroups[date] = { temps: [], symbols: [], precipTotal: 0, hours: [] };
        }
        const temp = point.data.instant.details.air_temperature;
        dailyGroups[date].temps.push(temp);
        
        const precip = point.data.next_1_hours?.details?.precipitation_amount || point.data.next_6_hours?.details?.precipitation_amount || 0;
        dailyGroups[date].precipTotal += precip;

        // Uzmi najrelevantniji simbol (prioritet: 1h > 6h > 12h)
        const next1 = point.data.next_1_hours?.summary?.symbol_code;
        const next6 = point.data.next_6_hours?.summary?.symbol_code;
        const next12 = point.data.next_12_hours?.summary?.symbol_code;
        const symbolCode = next1 || next6 || next12;
        
        if (symbolCode) {
            // Očisti postfiks (_day, _night, _polartwilight)
            const cleanSymbol = symbolCode.split('_')[0];
            dailyGroups[date].symbols.push({
                code: cleanSymbol,
                priority: MET_SYMBOLS[cleanSymbol]?.priority || 0,
                time: time
            });
        }

        dailyGroups[date].hours.push({
            time: time,
            temp: temp,
            symbol: symbolCode,
            precip: precip,
            wind: point.data.instant.details.wind_speed,
            windDir: point.data.instant.details.wind_from_direction
        });
    });

    const today = new Date().toISOString().split('T')[0];
    state.hourlyData = {};
    const forecastList = Object.keys(dailyGroups).sort().map(date => {
         const dayData = dailyGroups[date];
         const min = Math.min(...dayData.temps);
         const max = Math.max(...dayData.temps);
         state.hourlyData[date] = dayData.hours;
         
         // Odaberi najrelevantniji simbol za dan (najviši prioritet)
         // Fokus na dnevne sate (06:00 - 20:00) jer su relevantniji
         const daytimeSymbols = dayData.symbols.filter(s => {
             const hour = parseInt(s.time.split(':')[0]);
             return hour >= 6 && hour <= 20;
         });
         
         const symbolsToCheck = daytimeSymbols.length > 0 ? daytimeSymbols : dayData.symbols;
         
         // Sortiraj po prioritetu (viši = lošije vrijeme = važnije)
         const sortedSymbols = symbolsToCheck.sort((a, b) => b.priority - a.priority);
         const dominantSymbol = sortedSymbols[0]?.code || 'cloudy';
         
         const d = new Date(date);
         const dayName = date === today ? 'Danas' : d.toLocaleDateString('hr-HR', { weekday: 'long' });
         const formattedDay = dayName.charAt(0).toUpperCase() + dayName.slice(1);

         return { 
             date: date, 
             dayName: formattedDay, 
             min: Math.round(min), 
             max: Math.round(max), 
             symbol: dominantSymbol,
             precip: dayData.precipTotal 
         };
    });
    state.forecastData = forecastList.filter(f => f.date >= today);
    state.forecastUpdated = new Date().toLocaleTimeString('hr-HR', {hour: '2-digit', minute:'2-digit'});
    if (state.activeTab === VIEW_STATE.HOME) render();
      }
      async function fetchAgroMeteoHr() {
        const proxyUrl = 'https://corsproxy.io/?';
        const urlXml = 'https://klima.hr/agro_bilten.xml';
        try {
            const res = await fetch(proxyUrl + encodeURIComponent(urlXml));
            if (!res.ok) throw new Error("Failed to fetch Agro XML");
            const text = await res.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, 'text/xml');
            
            let forecastPeriod = "Agro Prognoza";
            const prognozaNode = xmlDoc.querySelector('prognoza');
            if (prognozaNode) {
                const interval = prognozaNode.querySelector('interval_prognoze');
                if (interval) forecastPeriod = interval.textContent.trim();
            } else {
                const interval = xmlDoc.querySelector('interval_prognoze');
                if (interval) forecastPeriod = interval.textContent.trim();
            }

            const stanjeNode = xmlDoc.querySelector('stanje');
            let stanje = stanjeNode ? stanjeNode.textContent.trim() : null;

            let forecast = null;
            if (prognozaNode) {
                 const pssz = prognozaNode.querySelector('p_ssz');
                 if (pssz) forecast = pssz.textContent.trim();
            }
            if (!forecast) {
                const pssz = xmlDoc.querySelector('p_ssz');
                if (pssz) forecast = pssz.textContent.trim();
            }

            let outlook = null;
            let outlookPeriod = null;
            const izglediNode = xmlDoc.querySelector('izgledi');
            if (izglediNode) {
                 const intIzgleda = izglediNode.querySelector('interval_izgleda');
                 if (intIzgleda) outlookPeriod = intIzgleda.textContent.trim();
                 const unutrasnjost = izglediNode.querySelector('unutrasnjost');
                 if (unutrasnjost) outlook = unutrasnjost.textContent.trim();
            } else {
                 const unutrasnjost = xmlDoc.querySelector('unutrasnjost');
                 if (unutrasnjost) outlook = unutrasnjost.textContent.trim();
                 const intIzgleda = xmlDoc.querySelector('interval_izgleda');
                 if (intIzgleda) outlookPeriod = intIzgleda.textContent.trim();
            }

            state.agroMeteo = { stanje, forecast, forecastPeriod, outlook, outlookPeriod };
            if (state.activeTab === VIEW_STATE.HOME || state.activeTab === VIEW_STATE.AGRO) render();
        } catch (e) {
            console.error("Agro Meteo XML fetch failed", e);
        }
      }

      async function fetchAgroData() {
        state.isAgroLoading = true;
        render(); 
        const targetUrl = 'https://savjetodavna.mps.hr/preporuke/?tx_post_tag=koprivnicko-krizevacka';
        const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);
        try {
          const res = await fetch(proxyUrl);
          if (!res.ok) throw new Error("Proxy error");
          const text = await res.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(text, 'text/html');
          const titleLinks = Array.from(doc.querySelectorAll('h3.pt-cv-title a')).slice(0, 10);
          if (titleLinks.length === 0) {
             const fallbackLinks = Array.from(doc.querySelectorAll('.entry-title a')).slice(0, 10);
             if(fallbackLinks.length > 0) titleLinks.push(...fallbackLinks);
          }
          const articles = await Promise.all(titleLinks.map(async (linkEl, index) => {
             const title = linkEl.textContent.trim();
             let href = linkEl.getAttribute('href');
             if (!href.startsWith('http')) href = `https://savjetodavna.mps.hr${href}`;
             const category = categorizeTitle(title);
             let summary = 'Učitavanje sadržaja preporuke...';
             let date = 'Nedavno';
             try {
                const detailRes = await fetch('https://corsproxy.io/?' + encodeURIComponent(href));
                const detailText = await detailRes.text();
                const detailDoc = parser.parseFromString(detailText, 'text/html');
                const contentEl = detailDoc.querySelector('.entry-content') || detailDoc.querySelector('.post-content') || detailDoc.querySelector('article');
                if (contentEl) {
                    const scripts = contentEl.querySelectorAll('script, style');
                    scripts.forEach(s => s.remove());
                    const cleanText = contentEl.innerText || contentEl.textContent;
                    summary = cleanText.replace(/\s+/g, ' ').trim().substring(0, 300) + '...';
                }
                const dateEl = detailDoc.querySelector('time') || detailDoc.querySelector('.entry-date');
                if (dateEl) date = dateEl.textContent.trim();
             } catch (err) { console.warn("Nije moguće dohvatiti detalje za", href); }
             return { id: index, category: category.name, title: title, summary: summary, date: date, icon: category.icon, color: category.color, bg: category.bg, link: href };
          }));
          state.agroData = articles.filter(a => a !== null);
          if (state.activeTab === VIEW_STATE.HOME) render();
        } catch (e) {
          console.error("Agro fetch failed", e);
          state.agroData = [];
        } finally {
          state.isAgroLoading = false;
          if (state.activeTab === VIEW_STATE.AGRO) render();
        }
      }

      function getLatestMeasurementTime() {
        const now = new Date();
        const adjusted = new Date(now.getTime() - 20 * 60000); 
        const minutes = adjusted.getMinutes();
        const roundedMinutes = minutes - (minutes % 10);
        adjusted.setMinutes(roundedMinutes);
        adjusted.setSeconds(0);
        const pad = (n) => n.toString().padStart(2, '0');
        return `${adjusted.getFullYear()}-${pad(adjusted.getMonth() + 1)}-${pad(adjusted.getDate())} ${pad(adjusted.getHours())}:${pad(adjusted.getMinutes())}:00`;
      }

      async function fetchWeatherData() {
        if (state.stationsMap.size === 0) {
            state.isLoading = true;
            render();
        }
        const timeString = getLatestMeasurementTime();
        state.lastUpdated = timeString;
        const proxyUrl = 'https://corsproxy.io/?';
        const baseUrl = 'https://meteopodaci.dhz.hr/wfs';
        const requests = Object.keys(MEASUREMENT_IDS).map(id => {
             const params = new URLSearchParams({ request: 'GetFeature', version: '1.1.0', outputFormat: 'application/json', typeName: 'standardna_mjerenja', viewparams: `meteomjernielementid:${id};termin_time:'${timeString}'` });
            return fetch(`${proxyUrl}${encodeURIComponent(baseUrl + '?' + params.toString())}`).then(r => r.json()).then(data => ({ id, data })).catch(e => ({ id, error: e }));
        });

        try {
            const results = await Promise.all(requests);
            const newStationsMap = new Map();
             if (typeof proj4 !== 'undefined') {
                proj4.defs("EPSG:3765","+proj=tmerc +lat_0=0 +lon_0=16.5 +k=0.9999 +x_0=500000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
            }
            results.forEach(({id, data}) => {
                if (data && data.features) {
                    const propName = MEASUREMENT_IDS[id];
                    data.features.forEach(f => {
                         const rawName = f.properties.naziv_postaje || f.properties.naziv || '';
                         const cleanName = rawName.split('-')[0].trim();
                         if (!newStationsMap.has(cleanName)) {
                            let x = parseFloat(f.properties.duzina); 
                            let y = parseFloat(f.properties.sirina);
                            if ((isNaN(x) || isNaN(y)) && f.geometry && f.geometry.coordinates) {
                                x = parseFloat(f.geometry.coordinates[0]);
                                y = parseFloat(f.geometry.coordinates[1]);
                            }
                            let lat = y; let lon = x;
                            if (typeof proj4 !== 'undefined' && !isNaN(x) && !isNaN(y) && (x > 180 || y > 180)) {
                                try {
                                    const converted = proj4('EPSG:3765', 'EPSG:4326', [x, y]);
                                    lon = converted[0]; lat = converted[1];
                                } catch (e) {}
                            }
                            newStationsMap.set(cleanName, { naziv: cleanName, lat: lat, lon: lon, temp: null, windSpeed: null, windDir: null, humidity: null, pressure: null });
                         }
                         const station = newStationsMap.get(cleanName);
                         const val = parseFloat(f.properties.vrijednost);
                         if (!isNaN(val)) { station[propName] = val; }
                    });
                }
            });
            state.stationsMap = newStationsMap;
            findNearestStation();
            if (mapInstance && state.activeTab === VIEW_STATE.HOME) { updateMapMarkers(); }
        } catch (e) {
            console.error("Error fetching weather data", e);
        } finally {
            state.isLoading = false;
            if (state.activeTab === VIEW_STATE.HOME) { if (!mapInstance) render(); updateDashboard(); } else if (state.activeTab !== VIEW_STATE.HOME) { render(); }
        }
      }

      async function fetchWarnings() {
          const urls = { today: 'https://meteo.hr/upozorenja/cap_hr_today.xml', tomorrow: 'https://meteo.hr/upozorenja/cap_hr_tomorrow.xml', dayAfter: 'https://meteo.hr/upozorenja/cap_hr_day_after_tomorrow.xml' };
          try {
              const fetchXml = async (url) => {
                  const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
                  const text = await res.text();
                  return parseCapXml(text);
              };
              const [today, tomorrow, dayAfter] = await Promise.all([ fetchXml(urls.today), fetchXml(urls.tomorrow), fetchXml(urls.dayAfter) ]);
              state.warnings = { today, tomorrow, dayAfter };
              if(state.activeTab === VIEW_STATE.HOME) render();
          } catch (e) { console.error("Failed to fetch warnings", e); }
      }

      function parseCapXml(xmlString) {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlString, "text/xml");
          const infos = Array.from(xmlDoc.querySelectorAll('info'));
          const zagrebInfos = infos.filter(info => {
              const lang = info.querySelector('language')?.textContent || '';
              if (!lang.toLowerCase().includes('hr')) return false;
              const areaDesc = info.querySelector('areaDesc')?.textContent || '';
              return areaDesc.includes('Zagrebačka regija');
          });
          return zagrebInfos.map(info => {
              const severity = info.querySelector('severity')?.textContent || 'Unknown';
              const event = info.querySelector('event')?.textContent || '';
              const headline = info.querySelector('headline')?.textContent || '';
              const description = info.querySelector('description')?.textContent || '';
              const onset = info.querySelector('onset')?.textContent || '';
              const expires = info.querySelector('expires')?.textContent || '';
              let color = 'gray'; let bg = 'bg-gray-100'; let text = 'text-gray-800'; let border = 'border-gray-200'; let level = 0;
              if (severity === 'Extreme') { color = 'red'; level = 3; bg = 'bg-red-50 dark:bg-red-900/30'; text = 'text-red-800 dark:text-red-300'; border = 'border-red-200 dark:border-red-800'; } 
              else if (severity === 'Severe') { color = 'orange'; level = 2; bg = 'bg-orange-50 dark:bg-orange-900/30'; text = 'text-orange-800 dark:text-orange-300'; border = 'border-orange-200 dark:border-orange-800'; } 
              else if (severity === 'Moderate') { color = 'yellow'; level = 1; bg = 'bg-amber-50 dark:bg-amber-900/30'; text = 'text-amber-800 dark:text-amber-300'; border = 'border-amber-200 dark:border-amber-800'; } 
              else { color = 'green'; level = 0; bg = 'bg-green-50 dark:bg-green-900/30'; text = 'text-green-800 dark:text-green-300'; border = 'border-green-200 dark:border-green-800'; }
              let icon = 'warning';
              const ev = event.toLowerCase();
              if (ev.includes('wind') || ev.includes('vjetar')) icon = 'air';
              else if (ev.includes('rain') || ev.includes('kiša')) icon = 'rainy';
              else if (ev.includes('snow') || ev.includes('snijeg') || ev.includes('ice') || ev.includes('led')) icon = 'ac_unit';
              else if (ev.includes('thunder') || ev.includes('grmljav')) icon = 'thunderstorm';
              else if (ev.includes('fog') || ev.includes('magla')) icon = 'foggy';
              else if (ev.includes('heat') || ev.includes('vruć')) icon = 'thermostat';
              else if (ev.includes('cold') || ev.includes('hladn')) icon = 'severe_cold';
              return { severity, event, headline, description, onset, expires, color, bg, text, border, icon, level };
          }).sort((a, b) => b.level - a.level); 
      }

      function openWarningsModal(tab = 'today') { state.warningTab = tab; state.showWarningsModal = true; render(); document.body.style.overflow = 'hidden'; }
      function closeWarningsModal() { state.showWarningsModal = false; render(); document.body.style.overflow = ''; }
      function switchWarningTab(tab) { state.warningTab = tab; render(); }
      function openNewsModal(newsId) { const item = newsData.find(n => n.id === newsId); if (item) { state.selectedNews = item; render(); document.body.style.overflow = 'hidden'; } }
      function closeNewsModal() { state.selectedNews = null; render(); document.body.style.overflow = ''; }

      function getUserLocation() {
          const activeLoc = getActiveLocation();
          if (activeLoc.type === 'gps' && navigator.geolocation) {
              navigator.geolocation.getCurrentPosition((position) => {
                      state.locations[state.activeLocationIndex].lat = position.coords.latitude;
                      state.locations[state.activeLocationIndex].lon = position.coords.longitude;
                      saveLocations();
                      findNearestStation();
                      fetchForecastData(); 
                      fetchAirQuality();
                      fetchAstroData();
                      if (state.activeTab === VIEW_STATE.HOME) { updateDashboard(); updateMapMarkers(); }
                  }, (error) => { console.log("Geolocation denied or failed, using default."); fetchForecastData(); fetchAirQuality(); fetchAstroData(); }
              );
          } else { fetchForecastData(); fetchAirQuality(); fetchAstroData(); findNearestStation(); }
      }

      function findNearestStation() {
          const activeLoc = getActiveLocation();
          const targetLat = activeLoc.lat || 46.16;
          const targetLon = activeLoc.lon || 16.83;
          if (state.stationsMap.size === 0) { const def = state.stationsMap.get('Koprivnica') || Array.from(state.stationsMap.values())[0]; state.nearestStation = def; return; }
          let minInfo = { dist: Infinity, station: null };
          state.stationsMap.forEach(station => { if (station.lat && station.lon) { const dist = getDistanceFromLatLonInKm(targetLat, targetLon, station.lat, station.lon); if (dist < minInfo.dist) { minInfo = { dist, station }; } } });
          if (minInfo.station) { state.nearestStation = minInfo.station; }
      }

      function updateDashboard() {
          const s = state.nearestStation;
          if (!s) return;
          const activeLoc = getActiveLocation();
          const setTxt = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
          const displayCity = activeLoc.type === 'manual' ? activeLoc.name : s.naziv;
          setTxt('hero-city', displayCity);
          setTxt('hero-temp', s.temp !== null ? s.temp.toFixed(1) + '°' : '--');
          setTxt('widget-wind', s.windSpeed !== null ? s.windSpeed.toFixed(1) : '--');
          setTxt('widget-humidity', s.humidity !== null ? s.humidity.toFixed(0) + '%' : '--%');
          setTxt('widget-pressure', s.pressure !== null ? s.pressure.toFixed(0) : '--');
          if (state.lastUpdated) { setTxt('last-updated-time', state.lastUpdated.split(' ')[1].slice(0,5)); }
          const aqiEl = document.getElementById('widget-aqi');
          const aqiLabelEl = document.getElementById('widget-aqi-label');
          const aqiIconEl = document.getElementById('widget-aqi-icon');
          if(aqiEl) {
              const aqiData = getAqiStatus(state.aqi);
              aqiEl.textContent = state.aqi !== null ? state.aqi : '--';
              if(aqiLabelEl) { aqiLabelEl.textContent = aqiData.label; aqiLabelEl.className = `text-xs font-bold uppercase tracking-wide ${aqiData.color}`; }
              if(aqiIconEl) { aqiIconEl.textContent = aqiData.icon; aqiIconEl.className = `material-symbols-outlined text-2xl ${aqiData.color}`; }
          }
      }

      function toggleForecast() { state.isForecastExpanded = !state.isForecastExpanded; render(); }
      function openHourlyModal(date) { state.selectedDay = date; render(); document.body.style.overflow = 'hidden'; }
      function closeHourlyModal() { state.selectedDay = null; render(); document.body.style.overflow = ''; }

      async function searchPlaces(query) {
          if (!query || query.length < 3) { state.searchResults = []; render(); return; }
          state.isSearching = true; render();
          try {
              const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&accept-language=hr`);
              const data = await res.json();
              state.searchResults = data.map(place => ({ name: place.display_name.split(',')[0], fullName: place.display_name, lat: parseFloat(place.lat), lon: parseFloat(place.lon) }));
          } catch(e) { console.error(e); } finally { state.isSearching = false; render(); }
      }
      function handleSearchInput(e) { state.searchQuery = e.target.value; if (searchTimeout) clearTimeout(searchTimeout); searchTimeout = setTimeout(() => searchPlaces(state.searchQuery), 500); }
      function addLocation(place) { const newLoc = { id: Date.now(), name: place.name, type: 'manual', lat: place.lat, lon: place.lon }; state.locations.push(newLoc); state.activeLocationIndex = state.locations.length - 1; state.searchQuery = ''; state.searchResults = []; saveLocations(); render(); findNearestStation(); fetchForecastData(); fetchAirQuality(); fetchAstroData(); }
      function addGpsLocation() { const exists = state.locations.find(l => l.type === 'gps'); if (!exists) { state.locations.unshift({ id: 'gps', name: 'Moja Lokacija (GPS)', type: 'gps', lat: null, lon: null }); state.activeLocationIndex = 0; saveLocations(); getUserLocation(); render(); } }
      function removeLocation(index) { if (state.locations[index].type === 'gps') return; state.locations.splice(index, 1); if (state.activeLocationIndex >= index && state.activeLocationIndex > 0) { state.activeLocationIndex--; } saveLocations(); render(); getUserLocation(); }
      function setActiveLocation(index) { state.activeLocationIndex = index; saveLocations(); render(); getUserLocation(); }

      function initMap() {
          const mapEl = document.getElementById('map-home');
          if (!mapEl) return;
          if (mapInstance) mapInstance.remove();
          const activeLoc = getActiveLocation();
          const lat = activeLoc.lat || 46.16;
          const lon = activeLoc.lon || 16.83;
          mapInstance = L.map('map-home', { zoomControl: false, attributionControl: false }).setView([lat, lon], 9);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(mapInstance);
          markersLayer = L.layerGroup().addTo(mapInstance);
          updateMapMarkers();
          setTimeout(() => { mapInstance.invalidateSize(); }, 200);
      }
      function switchLayer(layerType) { state.activeLayer = layerType; document.querySelectorAll('.layer-btn').forEach(btn => { if (btn.dataset.layer === layerType) { btn.classList.add('bg-primary', 'text-white', 'border-transparent'); btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-200'); } else { btn.classList.remove('bg-primary', 'text-white', 'border-transparent'); btn.classList.add('bg-white', 'text-gray-700', 'border-gray-200'); } }); updateMapMarkers(); }
      function updateMapMarkers() {
          if (!mapInstance || !markersLayer) return;
          markersLayer.clearLayers();
          state.stationsMap.forEach(station => {
              if (station.lat && station.lon) {
                  let html = ''; let val = null;
                  switch(state.activeLayer) {
                      case LAYER_TYPES.TEMP: val = station.temp; if (val !== null) { html = `<div class="flex flex-col items-center group cursor-pointer hover:-translate-y-1 transition-transform z-10" style="width: 40px;"><div class="bg-white dark:bg-[#1e2936] px-2 py-1 rounded-lg shadow-lg mb-1 border border-primary/20 flex items-center justify-center min-w-[36px]"><span class="text-xs font-bold text-primary whitespace-nowrap">${val.toFixed(1)}°</span></div><span class="material-symbols-outlined text-primary text-3xl drop-shadow-md -mt-1">location_on</span></div>`; } break;
                      case LAYER_TYPES.WIND: val = station.windSpeed; if (val !== null) { const rot = station.windDir || 0; html = `<div class="flex flex-col items-center justify-center" style="width: 40px;"><div class="w-8 h-8 rounded-full bg-white dark:bg-[#1e2936] shadow-md flex items-center justify-center border border-green-500/30"><span class="material-symbols-outlined text-green-600 text-xl" style="transform: rotate(${rot}deg)">navigation</span></div><span class="text-[10px] font-bold text-green-700 bg-white/80 px-1 rounded mt-1">${val.toFixed(1)}</span></div>`; } break;
                      case LAYER_TYPES.HUMIDITY: val = station.humidity; if (val !== null) { html = `<div class="flex flex-col items-center group cursor-pointer z-10" style="width: 40px;"><div class="bg-blue-50 dark:bg-blue-900/40 px-2 py-1 rounded-lg shadow-lg mb-1 border border-blue-500/20 flex items-center justify-center min-w-[36px]"><span class="text-xs font-bold text-blue-600 whitespace-nowrap">${val.toFixed(0)}%</span></div><span class="w-2 h-2 bg-blue-500 rounded-full shadow-sm"></span></div>`; } break;
                      case LAYER_TYPES.PRESSURE: val = station.pressure; if (val !== null) { html = `<div class="flex flex-col items-center group cursor-pointer z-10" style="width: 40px;"><div class="bg-gray-50 dark:bg-gray-800 px-2 py-1 rounded-lg shadow-lg mb-1 border border-gray-400/20 flex items-center justify-center min-w-[36px]"><span class="text-[10px] font-bold text-gray-700 dark:text-gray-300 whitespace-nowrap">${val.toFixed(0)}</span></div><span class="w-2 h-2 bg-gray-500 rounded-full shadow-sm"></span></div>`; } break;
                  }
                  if (html) { const icon = L.divIcon({ className: 'custom-div-icon', html: html, iconSize: [40, 50], iconAnchor: [20, 48] }); L.marker([station.lat, station.lon], { icon: icon }).bindPopup(`<b class="text-sm">${station.naziv}</b>`).addTo(markersLayer); }
              }
          });
          const activeLoc = getActiveLocation();
          if (activeLoc.lat && activeLoc.lon) { const userIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500 border-2 border-white shadow-md"></span></div>`, iconSize: [12, 12], iconAnchor: [6, 6] }); L.marker([activeLoc.lat, activeLoc.lon], { icon: userIcon, zIndexOffset: 1000 }).addTo(markersLayer); }
      }

function initRadarMap() {
        const mapEl = document.getElementById('map-radar');
        if (!mapEl) return;
        if (mapInstance) mapInstance.remove();
        const activeLoc = getActiveLocation();
        const lat = activeLoc.lat || 46.16;
        const lon = activeLoc.lon || 16.83;
        
        // Ograniči zoom na razine gdje WMS servis radi dobro
        mapInstance = L.map('map-radar', { 
          zoomControl: true, 
          attributionControl: false, 
          dragging: true, 
          scrollWheelZoom: true, 
          doubleClickZoom: true, 
          touchZoom: true,
          minZoom: 7,
          maxZoom: 10
        }).setView([lat, lon], 9);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
          attribution: 'OSM', 
          opacity: 0.6,
          minZoom: 7,
          maxZoom: 10
        }).addTo(mapInstance);
        
        const ProxyWMS = L.TileLayer.WMS.extend({ 
          getTileUrl: function(coords) { 
            const url = L.TileLayer.WMS.prototype.getTileUrl.call(this, coords); 
            return 'https://corsproxy.io/?' + encodeURIComponent(url); 
          } 
        });
        
        state.radarFrames = [];
        const now = new Date();
        const buffer = 10; 
        const minutes = now.getMinutes();
        const startMinutes = minutes - (minutes % 10) - buffer;
        now.setMinutes(startMinutes); now.setSeconds(0); now.setMilliseconds(0);
        
        for (let i = 6; i >= 0; i--) {
            const t = new Date(now.getTime() - i * 10 * 60000);
            const pad = (n) => n.toString().padStart(2, '0');
            const termin = `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())} ${pad(t.getHours())}:${pad(t.getMinutes())}:00`;
            const layer = new ProxyWMS("https://meteopodaci.dhz.hr/wms", { 
              layers: 'radar:mv_117_1', 
              format: 'image/png', 
              transparent: true, 
              uppercase: true, 
              CQL_FILTER: `termin='${termin}'`,
              opacity: 0,
              minZoom: 7,
              maxZoom: 10
            });
            state.radarFrames.push({ 
              layer: layer, 
              time: `${pad(t.getHours())}:${pad(t.getMinutes())}`, 
              timestamp: t.getTime(),
              termin: termin
            });
            layer.addTo(mapInstance);
        }
        
        state.currentRadarIndex = state.radarFrames.length - 1;
        
        // Odmah prikaži trenutni frame
        state.radarFrames[state.currentRadarIndex].layer.setOpacity(0.8);
        updateRadarFrame();
        
        // Listener za zoom - refresh layera
        mapInstance.on('zoomend', function() {
          state.radarFrames.forEach(frame => {
            frame.layer.redraw();
          });
        });
        
        if (activeLoc.lat && activeLoc.lon) { 
          const userIcon = L.divIcon({ 
            className: 'custom-div-icon', 
            html: `<div class="relative flex h-4 w-4"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-4 w-4 bg-blue-500 border-2 border-white shadow-md"></span></div>`, 
            iconSize: [16, 16], 
            iconAnchor: [8, 8] 
          }); 
          L.marker([activeLoc.lat, activeLoc.lon], { icon: userIcon, zIndexOffset: 1000 }).addTo(mapInstance); 
        }
        
        setTimeout(() => { mapInstance.invalidateSize(); }, 200);
      }


      function updateRadarFrame() { state.radarFrames.forEach((frame, idx) => { frame.layer.setOpacity(idx === state.currentRadarIndex ? 0.8 : 0); }); const slider = document.getElementById('radar-slider'); const timeDisplay = document.getElementById('radar-time-display'); if (slider) slider.value = state.currentRadarIndex; if (timeDisplay) timeDisplay.textContent = state.radarFrames[state.currentRadarIndex]?.time || '--:--'; }
      function toggleRadar() { state.radarPlaying = !state.radarPlaying; const btn = document.getElementById('radar-play-btn'); if(btn) { const icon = btn.querySelector('span'); icon.textContent = state.radarPlaying ? 'pause' : 'play_arrow'; } if (state.radarPlaying) { radarInterval = setInterval(() => { state.currentRadarIndex = (state.currentRadarIndex + 1) % state.radarFrames.length; updateRadarFrame(); }, 1000); } else { clearInterval(radarInterval); } }
      function onRadarSliderChange(val) { state.currentRadarIndex = parseInt(val); updateRadarFrame(); if (state.radarPlaying) toggleRadar(); }

      function navigate(view) { if (state.activeTab === VIEW_STATE.RADAR && view !== VIEW_STATE.RADAR) { clearInterval(radarInterval); state.radarPlaying = false; } state.activeTab = view; render(); if (view === VIEW_STATE.AGRO) { fetchAgroData(); fetchAgroMeteoHr(); } }

      function renderNav() {
        const tabs = [ { id: VIEW_STATE.HOME, label: 'Početna', icon: 'home' }, { id: VIEW_STATE.RADAR, label: 'Radar', icon: 'map' }, { id: VIEW_STATE.AGRO, label: 'Agro', icon: 'agriculture' }, { id: VIEW_STATE.NEWS, label: 'Vijesti', icon: 'newspaper' }, { id: VIEW_STATE.SETTINGS, label: 'Postavke', icon: 'settings' } ];
        const mobileNavHtml = `<div class="md:hidden fixed bottom-0 w-full bg-surface-light dark:bg-surface-dark border-t border-gray-200 dark:border-gray-800 pb-safe pt-2 px-6 flex justify-between items-center z-50 h-[80px]">${tabs.map(tab => { const isActive = state.activeTab === tab.id; return `<button onclick="navigate('${tab.id}')" class="flex flex-col items-center gap-1 w-12 transition-colors duration-200 ${isActive ? 'text-primary' : 'text-gray-500 dark:text-gray-400'}"><span class="material-symbols-outlined ${isActive ? 'fill-1' : ''}" style="font-variation-settings: 'FILL' ${isActive ? 1 : 0}">${tab.icon}</span><span class="text-[10px] font-medium">${tab.label}</span></button>`; }).join('')}</div>`;
        const desktopNavHtml = `<div class="hidden md:flex flex-col w-64 fixed h-full bg-surface-light dark:bg-surface-dark border-r border-gray-200 dark:border-gray-800 p-4 z-50"><div class="flex items-center gap-2 mb-8 px-2"><span class="material-symbols-outlined text-primary text-3xl">cloud_circle</span><h1 class="text-xl font-bold text-[#111418] dark:text-white">Podravina Meteo</h1></div><nav class="flex flex-col gap-2">${tabs.map(tab => { const isActive = state.activeTab === tab.id; return `<button onclick="navigate('${tab.id}')" class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${isActive ? 'bg-blue-50 dark:bg-blue-900/20 text-primary font-bold' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800'}"><span class="material-symbols-outlined ${isActive ? 'fill-1' : ''}">${tab.icon}</span><span class="text-sm">${tab.label}</span></button>`; }).join('')}</nav><div class="mt-auto p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl"><p class="text-xs text-gray-500 mb-2">Izvor podataka</p><div class="flex items-center gap-2 mb-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span><span class="text-xs font-bold dark:text-gray-300">DHMZ WFS</span></div><div class="flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span><span class="text-xs font-bold dark:text-gray-300">MET Norway</span></div><div class="flex items-center gap-2 mt-1"><span class="w-1.5 h-1.5 rounded-full bg-red-500"></span><span class="text-xs font-bold dark:text-gray-300">meteo.hr (Meteoalarm)</span></div><div class="flex items-center gap-2 mt-1"><span class="w-1.5 h-1.5 rounded-full bg-orange-500"></span><span class="text-xs font-bold dark:text-gray-300">savjetodavna.mps.hr</span></div></div></div>`;
        return desktopNavHtml + mobileNavHtml;
      }
      function renderHeader() { return `<div class="md:hidden sticky top-0 z-40 flex items-center bg-surface-light dark:bg-surface-dark p-4 border-b border-gray-200 dark:border-gray-800 justify-between h-16 shadow-sm"><div class="flex items-center gap-2"><span class="material-symbols-outlined text-primary text-2xl">cloud_circle</span><h2 class="text-lg font-bold text-[#111418] dark:text-white">Podravina Meteo</h2></div><div class="flex items-center gap-2"><button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-[#111418] dark:text-white"><span class="material-symbols-outlined">search</span></button></div></div>`; }

      function renderHome() {
        const s = state.nearestStation || {};
        const temp = s.temp !== undefined && s.temp !== null ? s.temp.toFixed(1) + '°' : '--';
        const wind = s.windSpeed !== undefined && s.windSpeed !== null ? s.windSpeed.toFixed(1) : '--';
        const humidity = s.humidity !== undefined && s.humidity !== null ? s.humidity.toFixed(0) + '%' : '--%';
        const pressure = s.pressure !== undefined && s.pressure !== null ? s.pressure.toFixed(0) : '--';
        const activeLoc = getActiveLocation();
        const city = activeLoc.type === 'manual' ? activeLoc.name : s.naziv || 'Učitavanje...';
        const displayForecast = state.isForecastExpanded ? state.forecastData : state.forecastData.slice(0, 3);
        const forecastHtml = displayForecast.map(f => {
        const symbolData = MET_SYMBOLS[f.symbol] || { icon: 'cloud', class: 'text-gray-400', label: 'Nepoznato' };
        const gradient = f.symbol.includes('rain') || f.symbol.includes('sleet') || f.symbol.includes('snow') || f.symbol.includes('thunder') ? 'from-blue-300 to-blue-500' : 'from-yellow-300 to-orange-400';
        return renderForecastRow(f.date, f.dayName, f.min, f.max, symbolData.icon, gradient, symbolData.class, f.precip, f.symbol);
        }).join('');
        let activeWarning = null; let warningLabel = "Nema Upozorenja"; let warningDesc = "Nisu izdana upozorenja za Zagrebačku regiju."; let warningColor = "green"; let warningIcon = "check_circle";
        if (state.warnings.today && state.warnings.today.length > 0) { activeWarning = state.warnings.today[0]; warningLabel = "Upozorenje za danas"; } else if (state.warnings.tomorrow && state.warnings.tomorrow.length > 0) { activeWarning = state.warnings.tomorrow[0]; warningLabel = "Upozorenje za sutra"; }
        if (activeWarning) {
            const sevMap = { 'Moderate': 'Umjereno', 'Severe': 'Opasno', 'Extreme': 'Izuzetno opasno' }; const translatedSev = sevMap[activeWarning.severity] || activeWarning.severity;
            if (activeWarning.headline) { warningDesc = activeWarning.headline; } else { warningDesc = `${activeWarning.event} - ${translatedSev}`; }
            if (activeWarning.severity === 'Extreme') { warningColor = 'red'; warningIcon = 'warning'; } else if (activeWarning.severity === 'Severe') { warningColor = 'orange'; warningIcon = 'warning'; } else { warningColor = 'amber'; warningIcon = 'info'; }
        }
        const warningCardHtml = `<div onclick="openWarningsModal('${activeWarning && !state.warnings.today.length ? 'tomorrow' : 'today'}')" class="cursor-pointer bg-${warningColor}-50 dark:bg-${warningColor}-900/20 border border-${warningColor}-200 dark:border-${warningColor}-800 rounded-2xl p-4 flex gap-4 shadow-sm transition hover:shadow-md"><div class="bg-${warningColor}-100 dark:bg-${warningColor}-800/30 p-2 rounded-full h-min"><span class="material-symbols-outlined text-${warningColor}-600 dark:text-${warningColor}-500">${warningIcon}</span></div><div class="flex-1"><div class="flex justify-between items-start"><h4 class="font-bold text-${warningColor}-800 dark:text-${warningColor}-500">${warningLabel}</h4><span class="text-xs bg-white/50 dark:bg-black/20 px-2 py-0.5 rounded text-${warningColor}-800 dark:text-${warningColor}-400">meteo.hr</span></div><p class="text-sm text-${warningColor}-700 dark:text-${warningColor}-400 mt-1 leading-relaxed line-clamp-2">${warningDesc}</p></div></div>`;
        const agroMeteo = state.agroMeteo || {};
        const agroPeriod = agroMeteo.forecastPeriod || "Učitavanje...";
        const agroForecastText = agroMeteo.forecast ? agroMeteo.forecast.substring(0, 150) + (agroMeteo.forecast.length > 150 ? '...' : '') : "Dohvaćanje agrometeorološke prognoze...";
        const newsSliderHtml = newsData.map(news => `<div onclick="openNewsModal(${news.id})" class="min-w-[260px] max-w-[260px] snap-center flex flex-col gap-2 cursor-pointer group"><div class="w-full h-32 rounded-xl overflow-hidden bg-gray-100 dark:bg-gray-800 relative shadow-sm border border-gray-100 dark:border-gray-800">${news.image ? `<img src="${news.image}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500" alt="${news.title}" />` : `<div class="w-full h-full flex items-center justify-center text-gray-300 dark:text-gray-600"><span class="material-symbols-outlined text-4xl">image</span></div>`}<div class="absolute bottom-2 left-2 bg-white/90 dark:bg-black/60 px-2 py-0.5 rounded-md text-[10px] font-bold shadow-sm backdrop-blur-sm text-[#111418] dark:text-white">${news.date}</div></div><div><h4 class="font-bold text-sm text-[#111418] dark:text-white leading-tight mb-1 group-hover:text-primary transition-colors line-clamp-2">${news.title}</h4><p class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2">${news.summary}</p></div></div>`).join('');
        const aqiData = getAqiStatus(state.aqi);
        const astro = state.astro;

        return `
          <div class="fade-in flex flex-col gap-4 p-4 pb-28 md:p-8 max-w-7xl mx-auto w-full">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="lg:col-span-2 flex flex-col gap-6">
                <!-- Map Container -->
                <div class="relative w-full h-80 md:h-96 rounded-2xl overflow-hidden shadow-sm group bg-gray-200 dark:bg-gray-700">
                  <div id="map-home" class="absolute inset-0 z-0"></div>
                  <div class="absolute top-4 right-4 flex gap-2 overflow-x-auto max-w-[90%] hide-scrollbar z-[500]">
                    <button onclick="switchLayer('${LAYER_TYPES.TEMP}')" data-layer="${LAYER_TYPES.TEMP}" class="layer-btn px-3 py-1.5 rounded-full text-xs font-bold shadow-md transition-all ${state.activeLayer === LAYER_TYPES.TEMP ? 'bg-primary text-white' : 'bg-white text-gray-700'}">Temp</button>
                    <button onclick="switchLayer('${LAYER_TYPES.WIND}')" data-layer="${LAYER_TYPES.WIND}" class="layer-btn px-3 py-1.5 rounded-full text-xs font-bold shadow-md transition-all ${state.activeLayer === LAYER_TYPES.WIND ? 'bg-primary text-white' : 'bg-white text-gray-700'}">Vjetar</button>
                    <button onclick="switchLayer('${LAYER_TYPES.HUMIDITY}')" data-layer="${LAYER_TYPES.HUMIDITY}" class="layer-btn px-3 py-1.5 rounded-full text-xs font-bold shadow-md transition-all ${state.activeLayer === LAYER_TYPES.HUMIDITY ? 'bg-primary text-white' : 'bg-white text-gray-700'}">Vlaga</button>
                    <button onclick="switchLayer('${LAYER_TYPES.PRESSURE}')" data-layer="${LAYER_TYPES.PRESSURE}" class="layer-btn px-3 py-1.5 rounded-full text-xs font-bold shadow-md transition-all ${state.activeLayer === LAYER_TYPES.PRESSURE ? 'bg-primary text-white' : 'bg-white text-gray-700'}">Tlak</button>
                  </div>
                  <div class="absolute bottom-4 left-4 bg-white/90 dark:bg-black/60 backdrop-blur-sm px-3 py-1.5 rounded-full text-xs font-medium border border-white/20 shadow-sm z-[500]">
                    Ažurirano: <span id="last-updated-time">${state.lastUpdated ? state.lastUpdated.split(' ')[1].slice(0,5) : '--:--'}</span>
                  </div>
                </div>

                <!-- Info Cards -->
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                  <div>
                    <div class="flex items-center gap-2 text-primary text-sm font-bold mb-1 uppercase tracking-wider">
                      <span class="material-symbols-outlined text-lg">my_location</span>
                      <span>Odabrana lokacija</span>
                    </div>
                    <h1 id="hero-city" class="text-4xl md:text-2xl font-bold tracking-tight text-[#111418] dark:text-white">${city}</h1>
                    <p class="text-gray-500 dark:text-gray-400 font-medium text-lg mt-1">Trenutni podaci (najbliža postaja)</p>
                  </div>
                  <div class="text-right">
                    <span id="hero-temp" class="text-6xl md:text-5xl font-bold text-primary tracking-tighter">${temp}</span>
                  </div>
                </div>
                
                <!-- Stats Grid (Added AQI) -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div class="flex flex-col gap-2 rounded-2xl bg-white dark:bg-surface-dark p-4 shadow-sm border border-gray-100 dark:border-gray-800 items-center text-center transition hover:shadow-md">
                    <span class="material-symbols-outlined text-primary text-2xl">air</span>
                    <div><p id="widget-wind" class="text-[#111418] dark:text-white text-xl font-bold">${wind} <span class="text-sm font-normal text-gray-500">m/s</span></p><p class="text-gray-400 text-xs font-bold uppercase tracking-wide">Vjetar</p></div>
                  </div>
                  <div class="flex flex-col gap-2 rounded-2xl bg-white dark:bg-surface-dark p-4 shadow-sm border border-gray-100 dark:border-gray-800 items-center text-center transition hover:shadow-md">
                    <span class="material-symbols-outlined text-primary text-2xl">humidity_percentage</span>
                     <div><p id="widget-humidity" class="text-[#111418] dark:text-white text-xl font-bold">${humidity}</p><p class="text-gray-400 text-xs font-bold uppercase tracking-wide">Vlaga</p></div>
                  </div>
                  <div class="flex flex-col gap-2 rounded-2xl bg-white dark:bg-surface-dark p-4 shadow-sm border border-gray-100 dark:border-gray-800 items-center text-center transition hover:shadow-md">
                    <span class="material-symbols-outlined text-primary text-2xl">compress</span>
                     <div><p id="widget-pressure" class="text-[#111418] dark:text-white text-xl font-bold">${pressure}</p><p class="text-gray-400 text-xs font-bold uppercase tracking-wide">Tlak</p></div>
                  </div>
                  <div class="flex flex-col gap-2 rounded-2xl bg-white dark:bg-surface-dark p-4 shadow-sm border border-gray-100 dark:border-gray-800 items-center text-center transition hover:shadow-md">
                    <span id="widget-aqi-icon" class="material-symbols-outlined text-2xl ${aqiData.color}">${aqiData.icon}</span>
                     <div><p id="widget-aqi" class="text-[#111418] dark:text-white text-xl font-bold">${state.aqi !== null ? state.aqi : '--'}</p><p id="widget-aqi-label" class="text-xs font-bold uppercase tracking-wide ${aqiData.color}">${aqiData.label}</p><p class="text-gray-400 text-[9px] font-bold uppercase tracking-wide mt-1">Kvaliteta Zraka</p></div>
                  </div>
                </div>

                <!-- Astro Widget -->
                <div class="grid grid-cols-3 gap-4 bg-white dark:bg-surface-dark rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-800">
                    <div class="flex flex-col items-center justify-center gap-1 border-r border-gray-100 dark:border-gray-700">
                        <span class="material-symbols-outlined text-amber-500 text-2xl">wb_sunny</span>
                        <span class="text-xs font-bold uppercase text-gray-400 tracking-wider">Izlazak</span>
                        <span class="text-lg font-bold text-[#111418] dark:text-white">${astro.sunrise || '--:--'}</span>
                    </div>
                     <div class="flex flex-col items-center justify-center gap-1 border-r border-gray-100 dark:border-gray-700">
                        <span class="material-symbols-outlined text-orange-500 text-2xl">wb_twilight</span>
                        <span class="text-xs font-bold uppercase text-gray-400 tracking-wider">Zalazak</span>
                        <span class="text-lg font-bold text-[#111418] dark:text-white">${astro.sunset || '--:--'}</span>
                    </div>
                     <div class="flex flex-col items-center justify-center gap-1">
                        <span class="material-symbols-outlined text-2xl ${astro.moonPhase?.color || 'text-gray-400'}">${astro.moonPhase?.icon || 'brightness_3'}</span>
                        <span class="text-xs font-bold uppercase text-gray-400 tracking-wider">Mjesec</span>
                    </div>
                </div>

              </div>
              <div class="flex flex-col gap-6">
                ${warningCardHtml}
                <div class="bg-white dark:bg-surface-dark rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-800">
                  <div class="flex items-center justify-between mb-6"><h3 class="text-[#111418] dark:text-white text-lg font-bold">Prognoza</h3><button onclick="toggleForecast()" class="text-primary text-sm font-bold hover:underline">${state.isForecastExpanded ? 'Manje' : '10 Dana'}</button></div>
                  <div class="flex flex-col gap-6">${forecastHtml || '<div class="text-center text-gray-500 text-sm py-4">Učitavanje prognoze...</div>'}</div>
                </div>
                 <div class="bg-green-50 dark:bg-green-900/10 rounded-2xl p-6 shadow-sm border border-green-100 dark:border-green-900/30"><div class="flex items-center gap-2 mb-3"><span class="material-symbols-outlined text-green-600 dark:text-green-500">agriculture</span><h3 class="text-green-800 dark:text-green-500 font-bold uppercase text-xs tracking-wider">Agro Prognoza</h3></div><p class="text-[10px] uppercase font-bold text-green-700 dark:text-green-400 mb-2 opacity-80">${agroPeriod}</p><p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed mb-3 line-clamp-4">${agroForecastText}</p><button onclick="navigate('${VIEW_STATE.AGRO}')" class="text-green-700 dark:text-green-400 text-sm font-bold flex items-center gap-1 hover:gap-2 transition-all">Otvori Agro Kutak <span class="material-symbols-outlined text-sm">arrow_forward</span></button></div>
              </div>
            </div>
            <div class="mt-4 pt-6 border-t border-gray-200 dark:border-gray-800"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-[#111418] dark:text-white">Lokalne Zanimljivosti</h3><button onclick="navigate('${VIEW_STATE.NEWS}')" class="text-primary text-sm font-bold hover:underline">Sve vijesti</button></div><div class="flex overflow-x-auto gap-4 pb-4 -mx-4 px-4 snap-x hide-scrollbar">${newsSliderHtml}</div></div>
            ${state.selectedDay ? renderHourlyModal(state.selectedDay) : ''}
            ${state.showWarningsModal ? renderWarningsModal() : ''}
            ${state.selectedNews ? renderNewsModal() : ''}
          </div>
        `;
      }

  function renderForecastRow(date, day, min, max, icon, gradient, iconClass = 'text-amber-500', precip = 0, symbolCode = 'cloudy') {
  let precipHtml = '';
  if (precip > 0.1) {
       precipHtml = `<div class="flex items-center gap-1 mt-0.5"><span class="material-symbols-outlined text-blue-500 text-[14px]" style="font-variation-settings: 'FILL' 1">water_drop</span><span class="text-xs font-bold text-blue-600 dark:text-blue-400">${precip.toFixed(1)} mm</span></div>`;
  }
  
  // Dohvati label za tooltip
  const symbolData = MET_SYMBOLS[symbolCode] || { label: 'Nepoznato' };
  
  return `
    <div onclick="openHourlyModal('${date}')" class="flex items-center justify-between group cursor-pointer transition-colors rounded-xl p-2 hover:bg-gray-50 dark:hover:bg-gray-800/50">
      <div class="flex items-center gap-4">
        <div class="w-10 h-10 rounded-full bg-gray-50 dark:bg-gray-800 flex items-center justify-center group-hover:scale-110 transition-transform relative" title="${symbolData.label}">
          <span class="material-symbols-outlined ${iconClass}">${icon}</span>
          <div class="absolute hidden group-hover:block bottom-full mb-2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap z-50 pointer-events-none">
            ${symbolData.label}
            <div class="absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-gray-900"></div>
          </div>
        </div>
        <div class="flex flex-col"><span class="font-bold text-[#111418] dark:text-white text-sm">${day}</span>${precipHtml}</div>
      </div>
      <div class="flex items-center gap-4 w-1/2 justify-end">
        <span class="text-gray-500 dark:text-gray-400 text-lg font-bold w-10 text-right">${min}°</span>
        <div class="flex-1 h-1.5 rounded-full bg-gray-100 dark:bg-gray-800 overflow-hidden relative max-w-[80px]"><div class="absolute left-0 h-full bg-gradient-to-r ${gradient} opacity-80" style="width: ${Math.max(10, ((max-min)/20)*100)}%; left: 0%"></div></div>
        <span class="font-bold text-[#111418] dark:text-white text-lg w-10 text-right">${max}°</span>
        <span class="material-symbols-outlined text-gray-300">chevron_right</span>
      </div>
    </div>
  `;
}

      function renderHourlyModal(date) {
          const hours = state.hourlyData[date];
          if (!hours) return '';
          const dayInfo = state.forecastData.find(f => f.date === date);
          const dayName = dayInfo ? dayInfo.dayName : date;
          const activeLoc = getActiveLocation();
          const locationName = activeLoc.type === 'manual' ? activeLoc.name : (state.nearestStation ? state.nearestStation.naziv : 'Moja Lokacija');
          const rowsHtml = hours.map(h => {
          let symCode = h.symbol || 'cloudy';
          if(symCode.includes('_')) symCode = symCode.split('_')[0];
          const symbolData = MET_SYMBOLS[symCode] || { icon: 'cloud', class: 'text-gray-400', label: 'Nepoznato' };
          return `<div class="grid grid-cols-4 items-center p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 border-b border-gray-50 dark:border-gray-800/50 last:border-0"><div class="text-sm font-bold text-gray-500 dark:text-gray-400">${h.time}</div><div class="flex items-center gap-2"><div class="relative group/icon"><span class="material-symbols-outlined ${symbolData.class}" title="${symbolData.label}">${symbolData.icon}</span><div class="absolute hidden group-hover/icon:block bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap z-50 pointer-events-none">${symbolData.label}<div class="absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-gray-900"></div></div></div><span class="text-lg font-bold text-[#111418] dark:text-white">${Math.round(h.temp)}°</span></div><div class="flex items-center justify-center">${h.precip > 0 ? `<div class="flex items-center gap-1 bg-blue-50 dark:bg-blue-900/20 px-2 py-0.5 rounded-full"><span class="material-symbols-outlined text-blue-500 text-[12px]" style="font-variation-settings: 'FILL' 1">water_drop</span><span class="text-xs font-bold text-blue-600 dark:text-blue-400">${h.precip.toFixed(1)}</span></div>` : '<span class="text-xs text-gray-300">-</span>'}</div><div class="flex items-center justify-end gap-2 text-xs text-gray-500"><div title="Smjer vjetra: ${h.windDir}°" class="flex items-center justify-center w-6 h-6 rounded-full bg-gray-100 dark:bg-gray-800"><span class="material-symbols-outlined text-[14px] text-gray-700 dark:text-gray-300" style="transform: rotate(${h.windDir}deg)">navigation</span></div><span class="min-w-[40px] text-right">${Math.round(h.wind)} m/s</span></div></div>`;
          }).join('');
          return `<div class="fixed inset-0 z-[100] flex items-center justify-center p-4"><div class="absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200" onclick="closeHourlyModal()"></div><div class="relative bg-white dark:bg-[#1e2936] w-full max-w-md max-h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95 duration-200 border border-gray-100 dark:border-gray-700"><div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-[#151f29]"><div><h3 class="font-bold text-lg text-[#111418] dark:text-white">${dayName}</h3><p class="text-xs text-gray-500 dark:text-gray-400">Detaljna prognoza po satima</p></div><button onclick="closeHourlyModal()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition text-gray-500 dark:text-gray-400"><span class="material-symbols-outlined">close</span></button></div><div class="grid grid-cols-4 px-4 py-2 bg-gray-50/50 dark:bg-[#151f29]/50 text-[10px] font-bold text-gray-400 uppercase tracking-wider border-b border-gray-100 dark:border-gray-800"><div>Vrijeme</div><div>Temp</div><div class="text-center">Oborine</div><div class="text-right">Vjetar</div></div><div class="flex-1 overflow-y-auto p-2">${rowsHtml}</div><div class="p-4 bg-gray-50 dark:bg-[#151f29] border-t border-gray-100 dark:border-gray-800 text-xs text-gray-500 dark:text-gray-400 flex flex-col gap-1.5"><div class="flex justify-between items-center"><span class="flex items-center gap-1"><span class="material-symbols-outlined text-[14px]">location_on</span> Lokacija:</span><span class="font-bold text-gray-700 dark:text-gray-300">${locationName}</span></div><div class="flex justify-between items-center"><span class="flex items-center gap-1"><span class="material-symbols-outlined text-[14px]">update</span> Ažurirano:</span><span class="font-bold text-gray-700 dark:text-gray-300">${state.forecastUpdated || '--:--'}</span></div></div></div></div>`;
      }

      function renderNewsModal() {
          const news = state.selectedNews;
          if (!news) return '';
          return `<div class="fixed inset-0 z-[100] flex items-center justify-center p-4"><div class="absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200" onclick="closeNewsModal()"></div><div class="relative bg-white dark:bg-[#1e2936] w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95 duration-200 border border-gray-100 dark:border-gray-700"><div class="relative h-48 md:h-64 bg-gray-200 dark:bg-gray-800">${news.image ? `<img src="${news.image}" class="w-full h-full object-cover" alt="${news.title}" />` : `<div class="w-full h-full flex items-center justify-center text-gray-300 dark:text-gray-600"><span class="material-symbols-outlined text-6xl">image</span></div>`}<button onclick="closeNewsModal()" class="absolute top-4 right-4 bg-black/50 hover:bg-black/70 text-white rounded-full p-2 transition"><span class="material-symbols-outlined">close</span></button></div><div class="flex-1 overflow-y-auto p-6"><div class="flex items-center gap-2 mb-3 text-sm text-gray-500 dark:text-gray-400"><span class="material-symbols-outlined text-lg">calendar_today</span><span>${news.date}</span></div><h2 class="text-2xl font-bold text-[#111418] dark:text-white mb-4 leading-tight">${news.title}</h2><div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 leading-relaxed">${news.content}</div></div></div></div>`;
      }

      function renderWarningsModal() {
          const warnings = state.warnings[state.warningTab] || [];
          const warningList = warnings.length > 0 ? warnings.map(w => {
             const start = formatWarningTime(w.onset); const end = formatWarningTime(w.expires);
             return `<div class="${w.bg} border ${w.border} p-4 rounded-xl mb-3 last:mb-0 shadow-sm"><div class="flex items-center gap-3 mb-3"><span class="material-symbols-outlined ${w.text} text-3xl">${w.icon}</span><div><h4 class="font-bold ${w.text} text-lg leading-tight">${w.headline || w.event}</h4><span class="text-xs font-bold uppercase tracking-wide opacity-80 ${w.text}">${w.severity === 'Moderate' ? 'Umjereno' : w.severity === 'Severe' ? 'Opasno' : w.severity === 'Extreme' ? 'Izuzetno opasno' : w.severity}</span></div></div><p class="text-sm ${w.text} mb-4 leading-relaxed opacity-90">${w.description}</p><div class="flex items-center justify-between bg-white/60 dark:bg-black/20 rounded-lg p-3 border ${w.border} border-opacity-50"><div class="flex flex-col text-${w.color}-900 dark:text-${w.color}-100"><span class="text-[10px] font-bold uppercase opacity-60">Početak</span><span class="text-xl font-bold leading-none my-0.5">${start.time}</span><span class="text-[10px] font-medium opacity-80 uppercase tracking-wide">${start.date}</span></div><div class="flex-1 mx-4 flex items-center relative"><div class="w-full h-0.5 bg-current opacity-30 rounded-full"></div><div class="absolute right-0 -top-2 text-current opacity-50 text-xs">▼</div></div><div class="flex flex-col items-end text-right text-${w.color}-900 dark:text-${w.color}-100"><span class="text-[10px] font-bold uppercase opacity-60">Kraj</span><span class="text-xl font-bold leading-none my-0.5">${end.time}</span><span class="text-[10px] font-medium opacity-80 uppercase tracking-wide">${end.date}</span></div></div></div>`;
          }).join('') : `<div class="flex flex-col items-center justify-center p-8 text-center text-gray-500 dark:text-gray-400"><span class="material-symbols-outlined text-4xl mb-2 text-green-500">check_circle</span><p>Nema aktivnih upozorenja za odabrani period.</p></div>`;
          const tabs = [ { id: 'today', label: 'Danas' }, { id: 'tomorrow', label: 'Sutra' }, { id: 'dayAfter', label: 'Prekosutra' } ];
          return `<div class="fixed inset-0 z-[100] flex items-center justify-center p-4"><div class="absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200" onclick="closeWarningsModal()"></div><div class="relative bg-white dark:bg-[#1e2936] w-full max-w-md max-h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95 duration-200 border border-gray-100 dark:border-gray-700"><div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-[#151f29]"><div class="flex items-center gap-2"><span class="material-symbols-outlined text-amber-500">warning</span><div><h3 class="font-bold text-lg text-[#111418] dark:text-white">Meteoalarm</h3><p class="text-xs text-gray-500 dark:text-gray-400">Zagrebačka regija</p></div></div><button onclick="closeWarningsModal()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition text-gray-500 dark:text-gray-400"><span class="material-symbols-outlined">close</span></button></div><div class="flex p-2 gap-2 border-b border-gray-100 dark:border-gray-800">${tabs.map(t => `<button onclick="switchWarningTab('${t.id}')" class="flex-1 py-2 rounded-lg text-sm font-bold transition ${state.warningTab === t.id ? 'bg-primary text-white shadow-md' : 'text-gray-500 hover:bg-gray-50 dark:hover:bg-gray-800'}">${t.label}</button>`).join('')}</div><div class="flex-1 overflow-y-auto p-4 flex flex-col gap-4">${warningList}</div><div class="p-4 bg-gray-50 dark:bg-[#151f29] border-t border-gray-100 dark:border-gray-800 text-xs text-gray-500 dark:text-gray-400 flex justify-between items-center"><span>Izvor podataka:</span><a href="https://meteo.hr" target="_blank" class="font-bold text-primary hover:underline">meteo.hr (DHMZ)</a></div></div></div>`;
      }

      function renderRadar() {
        return `<div class="fade-in flex-1 relative w-full h-[calc(100vh-80px)] md:h-screen bg-gray-100 overflow-hidden ml-0 md:ml-64"><div id="map-radar" class="absolute inset-0 z-0"></div><div class="absolute top-4 right-4 flex flex-col gap-2 z-10"><button class="bg-white/90 dark:bg-surface-dark/90 backdrop-blur-md w-10 h-10 rounded-lg shadow-lg flex items-center justify-center text-[#111418] dark:text-white hover:bg-gray-50 dark:hover:bg-gray-800 transition"><span class="material-symbols-outlined">layers</span></button></div><div class="absolute top-4 left-4 z-10 bg-white/90 dark:bg-[#1e2936]/90 backdrop-blur-sm p-3 rounded-lg shadow-md border border-gray-100 dark:border-gray-700 w-40"><div class="flex justify-between items-center mb-1"><span class="text-[10px] uppercase font-bold text-gray-500 dark:text-gray-400">Intenzitet (mm/h)</span></div><div class="h-2 w-full rounded-full bg-gradient-to-r from-blue-300 via-green-400 via-yellow-400 to-red-600"></div><div class="flex justify-between text-[9px] text-gray-500 dark:text-gray-400 mt-1 font-medium"><span>0</span><span>5</span><span>10</span><span>30+</span></div></div><div class="absolute bottom-24 md:bottom-8 left-4 right-4 md:left-8 md:right-8 z-[500]"><div class="bg-white/95 dark:bg-surface-dark/95 backdrop-blur-xl p-4 md:p-6 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700 max-w-3xl mx-auto"><div class="flex justify-between items-center mb-4"><div class="flex items-center gap-2"><span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span><span class="text-xs font-bold text-[#111418] dark:text-white tracking-widest uppercase">Radar Uživo</span></div><span id="radar-time-display" class="text-xs font-mono font-bold text-primary bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-md">--:--</span></div><div class="flex items-center gap-4 md:gap-6"><button id="radar-play-btn" onclick="toggleRadar()" class="flex-none flex items-center justify-center w-14 h-14 rounded-full bg-primary text-white shadow-lg hover:scale-105 transition-transform active:scale-95"><span class="material-symbols-outlined text-3xl fill-1">${state.radarPlaying ? 'pause' : 'play_arrow'}</span></button><div class="flex-1 flex flex-col gap-2"><input id="radar-slider" type="range" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full appearance-none cursor-pointer accent-primary" min="0" max="6" value="6" oninput="onRadarSliderChange(this.value)"><div class="flex justify-between text-[10px] font-bold text-gray-400 uppercase tracking-wider"><span>-1h</span><span>-30m</span><span>Sada</span></div></div></div></div></div></div>`;
      }

      function renderAgro() {
          const articlesHtml = state.isAgroLoading ? `<div class="flex justify-center flex-col items-center p-12 gap-4"><span class="material-symbols-outlined animate-spin text-4xl text-primary">progress_activity</span><p class="text-sm text-gray-500">Učitavanje detaljnih preporuka...</p></div>` : state.agroData.length > 0 ? state.agroData.map(article => `<div class="group flex flex-col bg-white dark:bg-surface-dark rounded-xl overflow-hidden shadow-sm border border-gray-100 dark:border-gray-800 hover:shadow-md transition"><div class="h-40 ${article.bg} relative flex items-center justify-center overflow-hidden"><div class="absolute inset-0 bg-gradient-to-tr from-white/20 to-transparent dark:from-black/20"></div><span class="material-symbols-outlined ${article.color} text-7xl opacity-80 group-hover:scale-110 transition duration-500">${article.icon}</span><div class="absolute top-3 left-3 bg-white/90 dark:bg-black/60 backdrop-blur-sm px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider text-[#111418] dark:text-white shadow-sm">${article.category}</div></div><div class="p-4 flex flex-col gap-2"><h3 class="text-lg font-bold text-[#111418] dark:text-white leading-tight">${article.title}</h3><p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-4 leading-relaxed">${article.summary}</p><div class="pt-3 flex items-center justify-between mt-auto border-t border-gray-100 dark:border-gray-800"><div class="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-500"><span class="material-symbols-outlined text-[14px]">schedule</span><span>${article.date}</span></div><a href="${article.link}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1 text-primary text-sm font-medium hover:underline">Pročitaj više <span class="material-symbols-outlined text-sm">arrow_forward</span></a></div></div></div>`).join('') : `<div class="text-center p-8 text-gray-500">Nema dostupnih savjeta. Provjerite vezu.</div>`;
          const forecastText = state.agroMeteo && state.agroMeteo.forecast ? state.agroMeteo.forecast : "Dohvaćanje prognoze...";
          const forecastPeriod = state.agroMeteo && state.agroMeteo.forecastPeriod ? `(${state.agroMeteo.forecastPeriod})` : "";
          const outlookText = state.agroMeteo && state.agroMeteo.outlook ? state.agroMeteo.outlook : "Dohvaćanje izgleda vremena...";
          const outlookPeriod = state.agroMeteo && state.agroMeteo.outlookPeriod ? `(${state.agroMeteo.outlookPeriod})` : "";
          const stanjeText = state.agroMeteo && state.agroMeteo.stanje ? state.agroMeteo.stanje : "Dohvaćanje stanja...";

          return `<div class="fade-in flex flex-col gap-4 p-4 md:p-8 max-w-2xl mx-auto w-full pb-28"><div class="flex flex-col gap-1 mt-2"><h1 class="text-2xl font-bold tracking-tight text-[#111418] dark:text-white">Agro Kutak</h1><p class="text-gray-500 dark:text-gray-400 text-sm">Stručni savjeti i agrometeorološke prognoze.</p><div class="flex gap-4"><a href="https://savjetodavna.mps.hr/preporuke/?tx_post_tag=koprivnicko-krizevacka" target="_blank" rel="noopener noreferrer" class="text-xs text-primary font-medium hover:underline w-fit">Posjeti MPS</a><a href="https://meteo.hr" target="_blank" rel="noopener noreferrer" class="text-xs text-primary font-medium hover:underline w-fit">Posjeti DHMZ</a></div></div><div class="flex flex-col gap-4"><div class="bg-amber-50 dark:bg-amber-900/10 rounded-xl p-5 shadow-sm border border-amber-100 dark:border-amber-900/30"><div class="flex items-center gap-2 mb-3"><span class="material-symbols-outlined text-amber-600 dark:text-amber-500">info</span><h3 class="text-amber-800 dark:text-amber-500 font-bold uppercase text-xs tracking-wider">Trenutno Stanje</h3></div><p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-wrap">${stanjeText}</p></div><div class="bg-green-50 dark:bg-green-900/10 rounded-xl p-5 shadow-sm border border-green-100 dark:border-green-900/30"><div class="flex items-center gap-2 mb-3"><span class="material-symbols-outlined text-green-600 dark:text-green-500">agriculture</span><h3 class="text-green-800 dark:text-green-500 font-bold uppercase text-xs tracking-wider">Agro Prognoza (P-SSZ) <span class="normal-case opacity-70 ml-1">${forecastPeriod}</span></h3></div><p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-wrap">${forecastText}</p></div><div class="bg-blue-50 dark:bg-blue-900/10 rounded-xl p-5 shadow-sm border border-blue-100 dark:border-blue-900/30"><div class="flex items-center gap-2 mb-3"><span class="material-symbols-outlined text-blue-600 dark:text-blue-500">calendar_month</span><h3 class="text-blue-800 dark:text-blue-500 font-bold uppercase text-xs tracking-wider">Agro Izgledi (Unutrašnjost) <span class="normal-case opacity-70 ml-1">${outlookPeriod}</span></h3></div><p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-wrap">${outlookText}</p></div></div><h3 class="font-bold text-sm uppercase text-gray-500 dark:text-gray-400 tracking-wider mt-2">Savjeti (MPS)</h3><div class="flex flex-col gap-4 mt-1">${articlesHtml}</div></div>`;
      }

      function renderNews() {
          const newsList = newsData.map(news => `<div onclick="openNewsModal(${news.id})" class="flex flex-col bg-white dark:bg-surface-dark rounded-xl overflow-hidden shadow-sm border border-gray-100 dark:border-gray-800 cursor-pointer hover:shadow-md transition group"><div class="h-48 md:h-56 bg-gray-200 dark:bg-gray-800 overflow-hidden relative">${news.image ? `<img src="${news.image}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500" alt="${news.title}" />` : `<div class="w-full h-full flex items-center justify-center text-gray-300 dark:text-gray-600"><span class="material-symbols-outlined text-6xl">image</span></div>`}</div><div class="p-5 flex flex-col gap-2"><div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 mb-1"><span class="material-symbols-outlined text-sm">calendar_today</span><span>${news.date}</span></div><h3 class="text-xl font-bold text-[#111418] dark:text-white leading-tight group-hover:text-primary transition-colors">${news.title}</h3><p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed line-clamp-3">${news.summary}</p><div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-800 text-primary text-sm font-bold flex items-center gap-1">Pročitaj više <span class="material-symbols-outlined text-sm">arrow_forward</span></div></div></div>`).join('');
          return `<div class="fade-in flex flex-col gap-6 p-4 md:p-8 max-w-3xl mx-auto w-full pb-28"><div class="flex flex-col gap-1 mt-2"><h1 class="text-2xl font-bold tracking-tight text-[#111418] dark:text-white">Lokalne Zanimljivosti</h1><p class="text-gray-500 dark:text-gray-400 text-sm">Meteorološki događaji i zanimljivosti iz Podravine.</p></div><div class="flex flex-col gap-6">${newsList}</div>${state.selectedNews ? renderNewsModal() : ''}</div>`;
      }

      function renderSettings() {
        const locationsList = state.locations.map((loc, index) => { const isActive = index === state.activeLocationIndex; const isGps = loc.type === 'gps'; return `<div class="flex items-center justify-between p-4 rounded-xl border transition-all cursor-pointer ${isActive ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 shadow-sm' : 'bg-white dark:bg-[#1e2936] border-gray-100 dark:border-gray-800 hover:border-blue-200 dark:hover:border-blue-800'}" onclick="setActiveLocation(${index})"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center ${isActive ? 'bg-blue-100 dark:bg-blue-800 text-primary dark:text-white' : 'bg-gray-50 dark:bg-gray-800 text-gray-400'}"><span class="material-symbols-outlined">${isGps ? 'my_location' : 'location_city'}</span></div><div><h4 class="font-bold text-sm text-[#111418] dark:text-white">${loc.name}</h4><p class="text-xs text-gray-500 dark:text-gray-400">${isGps ? 'Automatska lokacija' : 'Ručno dodano'}</p></div></div><div class="flex items-center gap-2">${isActive ? '<span class="material-symbols-outlined text-primary">check_circle</span>' : ''}${!isGps ? `<button onclick="event.stopPropagation(); removeLocation(${index})" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-full transition"><span class="material-symbols-outlined text-lg">delete</span></button>` : ''}</div></div>`; }).join('');
        const searchResultsHtml = state.searchResults.map(res => `<div onclick="addLocation({name: '${res.name}', lat: ${res.lat}, lon: ${res.lon}})" class="flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer border-b border-gray-100 dark:border-gray-800 last:border-0"><span class="material-symbols-outlined text-gray-400">location_on</span><div class="flex flex-col"><span class="font-bold text-sm text-[#111418] dark:text-white">${res.name}</span><span class="text-xs text-gray-400 line-clamp-1">${res.fullName}</span></div></div>`).join('');
        return `<div class="fade-in flex flex-col gap-6 p-4 md:p-8 max-w-2xl mx-auto md:ml-64 w-full"><div class="flex items-center gap-3 mb-2"><div class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center"><span class="material-symbols-outlined text-2xl text-gray-600 dark:text-gray-300">settings</span></div><div><h1 class="text-2xl font-bold text-[#111418] dark:text-white">Postavke</h1><p class="text-sm text-gray-500 dark:text-gray-400">Upravljanje lokacijama</p></div></div><div class="flex flex-col gap-4"><h3 class="font-bold text-sm uppercase text-gray-500 dark:text-gray-400 tracking-wider">Moje Lokacije</h3><div class="flex flex-col gap-3">${locationsList}</div>${!state.locations.find(l => l.type === 'gps') ? `<button onclick="addGpsLocation()" class="flex items-center justify-center gap-2 w-full p-3 rounded-xl border border-dashed border-primary/50 text-primary font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 transition"><span class="material-symbols-outlined">my_location</span> Dodaj "Moju lokaciju" (GPS)</button>` : ''}</div><div class="flex flex-col gap-4 pt-4 border-t border-gray-200 dark:border-gray-800"><h3 class="font-bold text-sm uppercase text-gray-500 dark:text-gray-400 tracking-wider">Dodaj Novo Mjesto</h3><div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><span class="material-symbols-outlined text-gray-400">search</span></div><input type="text" value="${state.searchQuery}" oninput="handleSearchInput(event)" placeholder="Pretraži gradove (npr. Zagreb, Split)..." class="w-full pl-10 pr-4 py-3 bg-white dark:bg-[#1e2936] border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-[#111418] dark:text-white shadow-sm transition" />${state.isSearching ? `<div class="absolute inset-y-0 right-0 pr-3 flex items-center"><span class="material-symbols-outlined animate-spin text-primary">progress_activity</span></div>` : ''}${state.searchResults.length > 0 ? `<div class="absolute top-full mt-2 w-full bg-white dark:bg-[#1e2936] rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 overflow-hidden z-50">${searchResultsHtml}</div>` : ''}</div><p class="text-xs text-gray-400">Koristi se OpenStreetMap baza podataka.</p></div></div>`;
      }

      function render() {
        if (state.activeTab !== VIEW_STATE.HOME && mapInstance && document.getElementById('map-home')) { mapInstance.remove(); mapInstance = null; }
        app.innerHTML = '';
        app.insertAdjacentHTML('beforeend', renderNav());
        let contentHtml = '';
        if (state.activeTab !== VIEW_STATE.RADAR && state.activeTab !== VIEW_STATE.SETTINGS) { contentHtml += renderHeader(); }
        switch (state.activeTab) { case VIEW_STATE.HOME: contentHtml += renderHome(); break; case VIEW_STATE.RADAR: contentHtml += renderRadar(); break; case VIEW_STATE.AGRO: contentHtml += renderAgro(); break; case VIEW_STATE.NEWS: contentHtml += renderNews(); break; case VIEW_STATE.SETTINGS: contentHtml += renderSettings(); break; }
        const mainContainer = document.createElement('div');
        mainContainer.className = "flex-1 w-full bg-background-light dark:bg-background-dark min-h-screen";
        mainContainer.innerHTML = contentHtml;
        app.appendChild(mainContainer);
        if (state.activeTab === VIEW_STATE.HOME) { setTimeout(initMap, 50); } else if (state.activeTab === VIEW_STATE.RADAR) { setTimeout(initRadarMap, 50); }
      }

      function init() {
        loadLocations();
        getUserLocation();
        fetchWeatherData();
        fetchWarnings();
        fetchAgroData(); 
        fetchAgroMeteoHr();
        fetchAstroData();
        setInterval(fetchWeatherData, 10 * 60 * 1000); 
        setInterval(fetchWarnings, 30 * 60 * 1000); 
        render();
      }
      init();
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>